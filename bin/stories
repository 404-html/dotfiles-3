#!/usr/bin/env python3

import frontmatter
import os
import glob
import wget
import re

# surpresses the download message of files
def bar_none(current, total, width=80):                                                                                                                                                         
    return ''; 

def format_slug(text):
	title_sliced = text.split()
	slug = ("-".join(title_sliced).lower())
	slug = slug.replace("?", "")
	slug = slug.replace("'", "")
	slug = re.sub("[\(\[].*?[\)\]]", "", slug)
	return slug

# move to directory in Dropbox to do the work
os.chdir('/home/wadeallen/Dropbox/Stories')

# file downloaded from Google Docs and stored as local text file
# it is worth noting that the Google Doc must be shared with an editable link
file_name = "stories.txt"
url = 'https://docs.google.com/document/d/1gKLaR2rWaPUAiBeqDUqhrrEDuw0g11Q9N2mp4GcFSLc/export?format=txt'
wget.download(url, file_name, bar = bar_none)

# The file is then split into multiple files 
# Be sure to have a file split at the beginning of the document
files = open(file_name,'r').read().split('*****')
names = ['story-'+ str(num) + '.md' for num in range(len(files))]
for num,file in enumerate(files):
    open(names[num],'w').write(file)

# Remove these files, no longer needed
os.remove('story-0.md')
os.remove('stories.txt')

# Grab stories for further use from the text files
path = 'story-[1-9]*.md'
stories = glob.glob(path)
stories =  sorted(stories)

# Sort out Stories for Website
website_dir = '/home/wadeallen/Dropbox/Stories/news/'
os.system('rm ' + website_dir + '*.md')
for story in stories:
	post = frontmatter.load(story)
	if 'website' in post['publications']:
		title = post['title']
		slug = format_slug(title)
		filename = website_dir + slug + '.md'
		target = open (filename, 'w')
		target.write("---\n")
		target.write("title: {}\n".format(title))
		target.write("weight: {}\n".format(post['weight']))
		target.write("---\n")
		target.write("\n")
		target.write(post.content)
		target.close()



# for story in stories:
# 	post = frontmatter.load(story)
# 	if 'website' in post['publications']:
# 		title = post['title']
# 		slug = format_slug(title)
# 		os.system('cp ' + story + ' news/' + slug + '.md')  

# for story in stories:
# 	post = frontmatter.load(story)
# 	if 'visitor' in post['publications']:
# 		print(post['title'], sep='\n')



